#!/bin/ksh
# 	*** definition of SLURM keywords ***
#SBATCH --job-name=opa_V11C.model
#SBATCH --mail-user=myocean-support@list.cineca.it,oper.med.ogs@inogs.it
#SBATCH --mail-type=BEGIN,END,FAIL
#
#SBATCH -o /g100/home/usera07ogs/a07ogs00/OPA/V11C/log/forecast/20250108/opa.g100.001.eo_slurm
#
#
#SBATCH -N5 -n 240 --mem=300gb
#SBATCH --time=06:00:00
#SBATCH -p g100_meteo_prod
#SBATCH --qos=qos_meteo
#DEPENDENCY IS OUTSIDE THE SCRIPT #SBATCH --dependency=
#SBATCH --export=OPA_RUNTIME_STEP=model
#SBATCH --account=OGS_prodC
#export RM_PROCS=$(/g100/home/usera07ogs/a07ogs00/OPA/V11C/HOST/g100/bin/cat "$SLURM_JOB_NODELIST" | /g100/home/usera07ogs/a07ogs00/OPA/V11C/HOST/g100/bin/tr '\n' ' ')
#export RM_NODES=$(/g100/home/usera07ogs/a07ogs00/OPA/V11C/HOST/g100/bin/cat "$SLURM_JOB_NODELIST" | /g100/home/usera07ogs/a07ogs00/OPA/V11C/HOST/g100/bin/sort -u | /g100/home/usera07ogs/a07ogs00/OPA/V11C/HOST/g100/bin/tr '\n' ' ')
export RM_NUM_PROCS=$SLURM_NTASKS
export RM_NUM_NODES=$SLURM_JOB_NUM_NODES
export RM_JOBID="$SLURM_JOBID"
{ ### start redirection of output/error to /g100/home/usera07ogs/a07ogs00/OPA/V11C/log/forecast/20250108/opa.g100.001.eo
export RT_OPA_RUNDATE="20250108"
export RT_OPA_RUNTYPE="forecast"
export RT_OPA_BATCH="true"
export RT_OPA_RUNID="001"

olj_command="/g100/home/usera07ogs/a07ogs00/OPA/V11C/bin/opa_log_job.ksh begin"
echo ">>> command '$olj_command' starting..."
eval $olj_command ; olj_ec=$?
echo "<<< command '$olj_command' completed [${olj_ec}]"

exit_code=0
command=/g100/home/usera07ogs/a07ogs00/OPA/V11C/log/forecast/20250108/opa.g100.001.step.${OPA_RUNTIME_STEP}
echo ">>> $command"
$command ; exit_code=$?
olj_command="/g100/home/usera07ogs/a07ogs00/OPA/V11C/bin/opa_log_job.ksh end --exit-code '$exit_code'"
echo ">>> command '$olj_command' starting..."
eval $olj_command ; olj_ec=$?
echo "<<< command '$olj_command' completed [${olj_ec}]"


} 1>"/g100/home/usera07ogs/a07ogs00/OPA/V11C/log/forecast/20250108/opa.g100.001.eo" 2>&1
exit $exit_code
